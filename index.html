<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京旅遊規劃 App (完整行程管理 - 持久化)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* 基礎樣式和字體設定 (保持不變) */
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
        .app-shell {
            max-width: 420px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #171717;
        }
        /* 隱藏原生滾動條 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 日期選單樣式 */
        .date-item { min-width: 72px; }

        /* 機票卡片虛線樣式 */
        .ticket-perforation { border-left: 2px dashed #d4d4d8; } 
        
        /* 展開/收合動畫 (用於備註區塊和機票卡片) */
        .collapse-enter-active, .collapse-leave-active {
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            max-height: 500px;
            opacity: 1;
            overflow: hidden;
        }
        .collapse-enter-from, .collapse-leave-to {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }

        /* 時間軸線條 (使用偽元素實現) */
        .timeline-item {
            position: relative;
            padding-bottom: 24px; 
        }
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 20px; 
            top: 40px; 
            bottom: -24px;
            width: 2px;
            background-color: #e5e7eb; 
            z-index: 0;
        }
        .timeline-dot-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 42px; 
            z-index: 1;
        }

        /* 購物清單完成項目樣式 */
        .shopping-done {
            text-decoration: line-through;
            opacity: 0.6;
            color: #737373;
        }
    </style>
</head>
<body>
    <div id="app" class="app-shell">

        <header class="p-4 bg-white text-violet-600 shadow-md sticky top-0 z-20 border-b border-neutral-200">
            <h1 class="text-xl font-bold text-center">東京旅程助手</h1>
        </header>

        <div v-if="activeTab === 'itinerary'" class="sticky top-16 bg-white shadow-sm border-b border-neutral-200 z-10">
            <div class="flex overflow-x-auto hide-scrollbar p-3 space-x-2">
                <button
                    v-for="date in travelDates"
                    :key="date"
                    @click="currentDate = date"
                    :class="{
                        'bg-violet-100 text-violet-700 border-b-2 border-violet-600': currentDate === date,
                        'bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition border-b-2 border-transparent': currentDate !== date
                    }"
                    class="date-item flex-shrink-0 text-center py-2 px-3 rounded-xl text-sm font-semibold transition duration-300"
                >
                    {{ date }}
                </button>
            </div>
        </div>

        <main class="flex-grow p-4 overflow-y-auto hide-scrollbar bg-neutral-100">
            
            <div v-if="activeTab === 'itinerary'">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-violet-700">
                        {{ currentDate }} 行程表
                        <span class="text-base font-normal text-neutral-500 ml-2">東京 {{ simulatedWeather }}</span>
                    </h2>
                    <button 
                        @click="openAddItemModal" 
                        class="bg-violet-600 hover:bg-violet-500 text-white p-2 rounded-full shadow-lg transition duration-200 flex items-center">
                        <i class="ph ph-plus text-xl"></i>
                    </button>
                </div>
                
                <section v-for="flight in currentFlights" :key="flight.id" class="mb-6">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border border-neutral-200">
                        <button 
                            @click="toggleCollapse(flight.id)" 
                            class="flex justify-between items-center w-full p-4 text-left font-bold"
                            :class="{'border-b border-neutral-200': !collapsedFlights[flight.id]}"
                        >
                            <div class="flex items-center">
                                <i class="text-xl mr-2" :class="flight.type === '去程 (DEPARTURE)' ? 'ph ph-airplane-takeoff text-violet-600' : 'ph ph-airplane-landing text-violet-600'"></i>
                                <span class="text-lg text-neutral-900">{{ flight.type }}：{{ flight.origin }} → {{ flight.destination }}</span>
                            </div>
                            <i class="ph text-lg text-neutral-500 transition-transform duration-300" :class="{'ph-caret-up': !collapsedFlights[flight.id], 'ph-caret-down': collapsedFlights[flight.id]}"></i>
                        </button>
                        <transition name="collapse">
                            <div v-if="!collapsedFlights[flight.id]" class="p-4 pt-0">
                                <div class="p-4 flex border border-violet-100 rounded-xl">
                                    <div class="flex-grow">
                                        <div class="flex items-center space-x-2 mb-3">
                                            <div class="flex flex-col">
                                                <p class="text-xs text-neutral-500">出發</p>
                                                <p class="text-3xl font-black text-neutral-900">{{ flight.origin }}</p>
                                            </div>
                                            <i class="ph ph-arrow-right text-3xl text-neutral-400"></i>
                                            <div class="flex flex-col">
                                                <p class="text-xs text-neutral-500">抵達</p>
                                                <p class="text-3xl font-black text-neutral-900">{{ flight.destination }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-24 flex-shrink-0 ticket-perforation pl-3 ml-3 flex flex-col justify-between">
                                        <div class="text-right mb-2">
                                            <span class="text-xs text-neutral-500 block">航班號碼</span>
                                            <span class="text-xl font-extrabold text-violet-700 block">{{ flight.flightNum }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>
                </section>


                <div v-if="currentDate === '12/18 (三)'" class="bg-white p-4 rounded-xl border-2 border-violet-300 mb-6 shadow-sm">
                    <h3 class="font-semibold text-lg mb-3 text-violet-700">12/18 行程方案選擇</h3>
                    <div class="flex space-x-3">
                        <button @click="dayTwoOption = 'A'" :class="{'bg-violet-600 text-white': dayTwoOption === 'A', 'bg-neutral-100 text-neutral-600 border border-neutral-300 hover:bg-violet-100': dayTwoOption !== 'A'}" class="flex-1 py-2 rounded-xl font-bold transition text-sm">
                            方案 A<br>(山中湖繞行)
                        </button>
                        <button @click="dayTwoOption = 'B'" :class="{'bg-violet-600 text-white': dayTwoOption === 'B', 'bg-neutral-100 text-neutral-600 border border-neutral-300 hover:bg-violet-100': dayTwoOption !== 'B'}" class="flex-1 py-2 rounded-xl font-bold transition text-sm">
                            方案 B<br>(直奔 Outlet)
                        </button>
                    </div>
                    <p class="text-xs text-neutral-500 mt-3 p-1 bg-neutral-50 rounded">
                        目前選定: <span class="font-bold text-violet-600">{{ dayTwoOption === 'A' ? '方案 A (停留山中湖)' : '方案 B (快速前往 Outlet)' }}</span>
                    </p>
                </div>
                
                <div v-if="itineraryWithDuration.length > 0" class="relative">
                    <div v-for="(item, index) in itineraryWithDuration" :key="item.id" 
                         class="timeline-item flex relative">
                        
                        <div class="timeline-dot-container flex-shrink-0 relative mr-4">
                            <div class="relative w-8 h-8 rounded-full border-2 border-white shadow-md mt-0.5 mb-1 z-10 flex items-center justify-center"
                                 :class="item.dotColor">
                                <i class="ph text-base text-white" :class="item.iconClass"></i>
                            </div>
                            <span class="text-lg font-black text-neutral-900">{{ item.time }}</span>
                            
                            <div v-if="item.duration !== 'N/A' && item.duration !== '結束'" 
                                 class="absolute top-12 left-full -translate-x-1/2 mt-4 z-10 bg-violet-50 text-violet-700 text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap shadow-sm border border-violet-200">
                                <i class="ph ph-clock text-xs align-middle mr-0.5"></i>
                                {{ item.duration }}
                            </div>
                        </div>

                        <div class="flex-grow min-w-0">
                            <div class="bg-white rounded-xl shadow-md border border-neutral-200 mb-0 relative transition duration-200 overflow-hidden">
                                
                                <div class="flex justify-between items-start w-full p-4">
                                    <button @click="toggleNote(item.id)" class="flex-grow text-left">
                                        <p class="text-neutral-900 font-semibold text-lg mb-0.5">
                                            {{ item.location }}
                                        </p>
                                        <p v-if="item.redNote" class="text-red-600 text-sm font-semibold mb-2">
                                            <i class="ph ph-warning-circle-fill mr-1"></i>
                                            {{ item.redNote }}
                                        </p>
                                        <div class="text-xs font-medium text-neutral-500 flex items-center mt-1">
                                            <i class="ph mr-1" :class="{'ph-caret-down-fill': item.showNote, 'ph-caret-right-fill': !item.showNote}"></i>
                                            {{ item.note && item.note.trim() ? '點擊查看/編輯備註與細節' : '點擊新增備註與細節...' }}
                                        </div>
                                    </button>
                                    
                                    <button @click.stop="editItem(item)" class="text-violet-600 hover:text-violet-500 p-2 rounded-full hover:bg-neutral-100 transition flex-shrink-0">
                                        <i class="ph ph-note-pencil text-lg"></i>
                                    </button>
                                </div>

                                <transition name="collapse">
                                    <div v-if="item.showNote" class="p-4 pt-0 border-t border-neutral-100">
                                        <h4 class="text-sm font-bold text-neutral-600 mb-2">備註與細節 (可編輯)</h4>
                                        <textarea
                                            v-model="item.note"
                                            class="w-full p-2 text-sm bg-neutral-50 border border-neutral-300 rounded-lg h-24 focus:ring-violet-500 focus:border-violet-500 transition resize-none whitespace-pre-wrap"
                                            placeholder="在此輸入您想紀錄的細節、訂位號碼、注意事項等..."
                                            @input="saveItineraryLocally"
                                        ></textarea>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative w-full flex justify-center mt-4">
                        <i class="ph ph-check-circle-fill text-3xl text-green-500"></i>
                    </div>

                </div>
                <p v-else class="text-center text-neutral-500 mt-8 p-4 bg-white rounded-xl border border-neutral-200">
                    目前 {{ currentDate }} 沒有行程。
                </p>

                <div v-if="isModalOpen" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-30">
                    <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl border border-neutral-200">
                        <h3 class="text-xl font-bold mb-4" :class="editingItem ? 'text-violet-600' : 'text-green-600'">
                            {{ editingItem ? '編輯行程' : '新增行程' }}
                        </h3>

                        <label class="block mb-2 text-sm font-medium text-neutral-600">日期</label>
                        <select v-model="tempItem.date" class="w-full p-2 bg-neutral-100 border border-neutral-300 text-neutral-900 rounded-lg mb-4">
                             <option v-for="date in travelDates" :key="date" :value="date">{{ date }}</option>
                        </select>
                        
                        <label class="block mb-2 text-sm font-medium text-neutral-600">時間 (HH:MM)</label>
                        <input v-model="tempItem.time" type="time" class="w-full p-2 bg-neutral-100 border border-neutral-300 text-neutral-900 rounded-lg mb-4">
                        
                        <label class="block mb-2 text-sm font-medium text-neutral-600">地點/描述</label>
                        <input v-model="tempItem.location" type="text" class="w-full p-2 bg-neutral-100 border border-neutral-300 text-neutral-900 rounded-lg mb-4">

                        <label class="block mb-2 text-sm font-medium text-neutral-600">行程類型</label>
                        <select v-model="tempItem.type" class="w-full p-2 bg-neutral-100 border border-neutral-300 text-neutral-900 rounded-lg mb-4">
                            <option value="attraction">景點 (Attraction)</option>
                            <option value="restaurant">餐廳 (Restaurant)</option>
                            <option value="transport">交通 (Transport)</option>
                        </select>

                        <div>
                            <label class="block mb-2 text-sm font-medium text-neutral-600">一般備註</label>
                            <textarea v-model="tempItem.note" class="w-full p-2 bg-neutral-100 border border-neutral-300 text-neutral-900 rounded-lg h-20 mb-4 resize-none" placeholder="在此輸入一般備註"></textarea>
                            
                            <label class="block mb-2 text-sm font-medium text-red-600">紅字重要備註</label>
                            <input v-model="tempItem.redNote" type="text" class="w-full p-2 bg-red-100 border border-red-300 text-neutral-900 rounded-lg mb-6" placeholder="選填：重要提醒 (紅字顯示)">
                        </div>

                        <div class="flex justify-between items-center">
                            <button v-if="editingItem" @click="deleteItem(editingItem.id)" class="px-4 py-2 text-white bg-red-600 font-bold rounded-xl hover:bg-red-500 transition">
                                刪除
                            </button>
                            
                            <div class="flex ml-auto space-x-3">
                                <button @click="closeModal" class="px-4 py-2 text-neutral-600 bg-neutral-200 rounded-xl hover:bg-neutral-300 transition">取消</button>
                                <button @click="saveItem" class="px-4 py-2 bg-violet-600 text-white font-bold rounded-xl hover:bg-violet-500 transition">
                                    {{ editingItem ? '儲存變更' : '新增行程' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="activeTab === 'ledger'">
                <h2 class="text-2xl font-bold mb-4 text-violet-700">旅遊記帳本</h2>
                
                <div class="bg-white text-neutral-900 p-4 rounded-xl border-2 border-violet-500 shadow-lg mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium opacity-80 text-neutral-600">總計已花費金額 (TWD)</p>
                        <p class="text-4xl font-extrabold mt-1 text-violet-600">
                            {{ totalTwdSpent.toFixed(0).toLocaleString() }}
                        </p>
                    </div>
                    <i class="ph ph-receipt-magnifying-glass text-5xl opacity-80 text-violet-500"></i>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md mb-6 border border-neutral-200">
                    <h3 class="font-semibold text-lg mb-3 text-violet-600">新增支出 (雙向換算)</h3>
                    
                    <div class="mb-4 p-2 bg-yellow-100 rounded-lg border border-yellow-300 text-sm font-medium text-yellow-800">
                        <i class="ph ph-arrow-left-right text-base align-middle mr-1 text-yellow-600"></i>
                        即時匯率: 1 JPY ≈ <span class="font-bold text-yellow-800">{{ jpyToTwdRate }}</span> TWD
                    </div>

                    <input v-model="newExpense.description" type="text" class="w-full p-2 bg-neutral-50 border border-neutral-300 text-neutral-900 rounded-lg mb-3" placeholder="描述 (例如: 晚餐)">
                    
                    <label class="block text-sm font-medium text-neutral-600 mb-1">金額 (JPY 日幣)</label>
                    <input 
                        :value="newExpense.amountJpy" 
                        @input="updateAmount('jpy', $event.target.value)" 
                        type="number" 
                        class="w-full p-2 bg-neutral-50 border border-neutral-300 text-neutral-900 rounded-lg mb-3" 
                        placeholder="請輸入日幣金額">

                    <div class="bg-violet-100 p-3 rounded-lg mb-4 border border-violet-300">
                        <label class="block text-sm font-medium text-violet-700">金額 (TWD 台幣)</label>
                        <input 
                            :value="calculatedTwdAmount" 
                            @input="updateAmount('twd', $event.target.value)" 
                            type="number" 
                            class="w-full p-2 mt-1 bg-violet-50 border border-violet-300 text-violet-900 rounded-lg text-xl font-extrabold"
                            placeholder="請輸入台幣金額">
                        <p class="text-xs text-violet-700 mt-2">
                             * 換算 JPY: {{ calculatedJpyAmount.toLocaleString(undefined, { maximumFractionDigits: 0 }) }}
                        </p>
                    </div>
                    
                    <label class="block text-sm font-medium text-neutral-600 mb-1">支出類別</label>
                    <select v-model="newExpense.category" class="w-full p-2 bg-neutral-50 border border-neutral-300 text-neutral-900 rounded-lg mb-3">
                        <option disabled value="" class="text-neutral-500 bg-white">請選擇類別</option>
                        <option v-for="c in expenseCategories" :key="c" class="bg-white text-neutral-900">{{ c }}</option>
                    </select>

                    <button @click="addExpense" :disabled="!canAddExpense" class="w-full bg-violet-600 hover:bg-violet-500 text-white font-bold py-2 rounded-xl transition disabled:bg-neutral-300 disabled:text-neutral-500">
                        記錄支出
                    </button>
                </div>

                <h3 class="font-bold text-lg mt-5 mb-3 text-violet-700 flex items-center">
                    <i class="ph ph-list-checks text-2xl mr-2"></i> 支出紀錄
                </h3>
                <div v-if="expenses.length > 0" class="space-y-3">
                    <div v-for="expense in sortedExpenses" :key="expense.id" 
                         class="bg-white p-4 rounded-xl border border-neutral-200 mb-2 transition duration-150 hover:border-violet-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-neutral-900">{{ expense.description }}</p>
                                <p class="text-xs text-neutral-500">{{ expense.date }}</p>
                            </div>
                            <div class="text-right flex items-center space-x-2">
                                <span class="text-sm font-medium px-2 py-0.5 rounded-full" :class="getCategoryColor(expense.category)">
                                    {{ expense.category }}
                                </span>
                                <button @click="deleteExpense(expense.id)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-end mt-2 border-t border-neutral-200 pt-2">
                             <p v-if="expense.amountJpy > 0" class="text-sm text-neutral-600">
                                 {{ expense.amountJpy.toLocaleString() }} JPY
                            </p>
                            <p v-else class="text-sm text-neutral-600 italic">
                                (原始 TWD 交易)
                            </p>
                            <p class="text-xl font-extrabold text-red-600">
                                -{{ expense.amount.toFixed(0).toLocaleString() }} TWD
                            </p>
                        </div>
                    </div>
                </div>
                <p v-else class="text-center text-neutral-500 mt-8 p-4 bg-white rounded-xl border border-neutral-200">
                    目前沒有支出紀錄。
                </p>
            </div>

            <div v-else-if="activeTab === 'map'">
                <h2 class="text-2xl font-bold mb-4 text-violet-700">地圖與導航</h2>
                
                <div class="bg-yellow-100 p-4 rounded-xl border border-yellow-300 mb-6 text-sm text-yellow-800">
                    <h3 class="font-semibold text-base mb-2 text-yellow-800 flex items-center">
                        <i class="ph ph-map-pin-line text-xl mr-2 text-yellow-600"></i>
                        行程自動路線規劃
                    </h3>
                    <p class="mb-3 text-neutral-800">
                        我們已自動將 {{ currentDate }} 的所有行程地點組合成一條導航路線。
                    </p>
                    <button @click="openItineraryRoute" :disabled="filteredItinerary.length === 0" class="w-full bg-violet-600 hover:bg-violet-500 text-white font-bold py-2 rounded-xl transition disabled:bg-neutral-300 disabled:text-neutral-500 flex items-center justify-center">
                        <i class="ph ph-map-trifold text-xl mr-2"></i> 開啟 Google Maps 導航
                    </button>
                    <p class="text-xs text-neutral-600 mt-2">（將在新視窗中開啟多點路線）</p>

                    <p class="text-xs text-neutral-600 mt-4">
                        <i class="ph ph-warning-circle text-base align-middle mr-1"></i>
                        **注意：** 此 App 運行於沙盒環境，無法取得您的即時 GPS 位置。
                    </p>
                </div>


                <div class="w-full h-80 bg-white rounded-xl shadow-inner flex flex-col items-center justify-center p-6 border-4 border-violet-500 border-dashed">
                    <i class="ph ph-compass-tool text-6xl text-violet-600 mb-3"></i>
                    <p class="text-center text-neutral-800 font-semibold">
                        地圖顯示區 (行程已自動釘選)
                    </p>
                    <p class="text-sm text-neutral-600 mt-2">
                        地點數：<span class="font-bold">{{ filteredItinerary.length }}</span> 個
                    </p>
                </div>
            </div>

            <div v-else-if="activeTab === 'shopping'">
                <h2 class="text-2xl font-bold mb-4 text-pink-600">購物清單</h2>
                
                <div class="bg-white p-4 rounded-xl shadow-md mb-6 border border-neutral-200">
                    <h3 class="font-semibold text-lg mb-3 text-pink-600">新增購物項目</h3>
                    
                    <input v-model="newShoppingItem.name" type="text" class="w-full p-2 bg-neutral-50 border border-neutral-300 text-neutral-900 rounded-lg mb-3" placeholder="商品名稱或描述">
                    
                    <div class="flex space-x-3 mb-3">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-neutral-600 mb-1">數量</label>
                            <input v-model.number="newShoppingItem.quantity" type="number" min="1" class="w-full p-2 bg-neutral-50 border border-neutral-300 text-neutral-900 rounded-lg" placeholder="數量">
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-neutral-600 mb-1">圖片參考 (選填)</label>
                            <input type="file" ref="imageInput" @change="handleImageUpload" accept="image/*" class="hidden">
                            <button @click="$refs.imageInput.click()" class="w-full py-2 bg-pink-100 text-pink-600 font-bold rounded-xl border border-pink-300 hover:bg-pink-200 transition text-sm flex items-center justify-center">
                                <i class="ph ph-image text-xl mr-2"></i> 上傳圖片
                            </button>
                        </div>
                    </div>

                    <p v-if="newShoppingItem.imagePreview" class="text-xs text-neutral-500 mb-3">
                        已選擇圖片 (點擊下方按鈕新增)
                    </p>

                    <button @click="addShoppingItem" :disabled="!canAddShoppingItem" class="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-2 rounded-xl transition disabled:bg-neutral-300 disabled:text-neutral-500">
                        加入清單
                    </button>
                </div>

                <h3 class="font-bold text-lg mt-5 mb-3 text-pink-600 flex items-center">
                    <i class="ph ph-shopping-bag text-2xl mr-2"></i> 待購項目 ({{ pendingShoppingItems.length }})
                </h3>
                <div v-if="shoppingList.length > 0" class="space-y-3">
                    <div v-for="item in sortedShoppingList" :key="item.id" 
                         :class="{'shopping-done': item.done, 'border-pink-500': !item.done, 'border-neutral-200': item.done}"
                         class="bg-white p-4 rounded-xl border-l-4 transition duration-150 shadow-sm flex items-center space-x-3">
                        
                        <button @click="toggleShoppingDone(item.id)" class="flex-shrink-0 text-2xl transition duration-150"
                                 :class="{'text-green-500 hover:text-green-600': !item.done, 'text-neutral-400 hover:text-neutral-500': item.done}">
                            <i class="ph" :class="{'ph-check-square-fill': item.done, 'ph-square': !item.done}"></i>
                        </button>

                        <div class="flex-grow min-w-0 flex items-center space-x-3">
                            <div v-if="item.image" class="w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden border border-neutral-200">
                                <img :src="item.image" alt="商品參考圖" class="w-full h-full object-cover">
                            </div>
                            <div :class="{'shopping-done': item.done}">
                                <p class="font-bold text-lg leading-snug">{{ item.name }}</p>
                                <p class="text-sm text-neutral-500 mt-0.5">數量: {{ item.quantity }}</p>
                            </div>
                        </div>

                        <button @click="deleteShoppingItem(item.id)" class="flex-shrink-0 text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>
                </div>
                <p v-else class="text-center text-neutral-500 mt-8 p-4 bg-white rounded-xl border border-neutral-200">
                    目前購物清單為空。
                </p>
            </div>


        </main>

        <nav class="bg-white border-t border-neutral-200 p-2 sticky bottom-0 z-20 shadow-xl">
            <div class="flex justify-around">
                <button @click="activeTab = 'itinerary'" :class="{'text-violet-600 border-violet-600': activeTab === 'itinerary', 'text-neutral-500 border-transparent': activeTab !== 'itinerary'}" class="flex flex-col items-center px-2 py-2 border-b-2 transition duration-200">
                    <i class="ph ph-calendar-blank text-2xl"></i>
                    <span class="text-xs font-medium">行程</span>
                </button>
                <button @click="activeTab = 'ledger'" :class="{'text-violet-600 border-violet-600': activeTab === 'ledger', 'text-neutral-500 border-transparent': activeTab !== 'ledger'}" class="flex flex-col items-center px-2 py-2 border-b-2 transition duration-200">
                    <i class="ph ph-currency-circle-dollar text-2xl"></i>
                    <span class="text-xs font-medium">記帳</span>
                </button>
                <button @click="activeTab = 'map'" :class="{'text-violet-600 border-violet-600': activeTab === 'map', 'text-neutral-500 border-transparent': activeTab !== 'map'}" class="flex flex-col items-center px-2 py-2 border-b-2 transition duration-200">
                    <i class="ph ph-map-pin text-2xl"></i>
                    <span class="text-xs font-medium">地圖</span>
                </button>
                <button @click="activeTab = 'shopping'" :class="{'text-pink-600 border-pink-600': activeTab === 'shopping', 'text-neutral-500 border-transparent': activeTab !== 'shopping'}" class="flex flex-col items-center px-2 py-2 border-b-2 transition duration-200">
                    <i class="ph ph-shopping-bag text-2xl"></i>
                    <span class="text-xs font-medium">購物</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, reactive } = Vue;

        // 輔助函式：計算時間差 (HH:MM 格式)
        const calculateDuration = (startTime, endTime) => {
            const toMinutes = (timeStr) => {
                if (!timeStr) return null;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };

            const startMin = toMinutes(startTime);
            const endMin = toMinutes(endTime);

            if (startMin === null || endMin === null) {
                return 'N/A';
            }

            let durationMin = endMin - startMin;

            if (durationMin < 0) {
                 return 'N/A'; 
            }

            const hours = Math.floor(durationMin / 60);
            const minutes = durationMin % 60;
            
            if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h`;
            if (minutes > 0) return `${minutes}m`;
            return 'N/A';
        };


        createApp({
            setup() {
                // --- 應用程式狀態 ---
                const activeTab = ref('itinerary');
                const nextId = ref(100); 
                const expenseNextId = ref(1000); 
                const shoppingNextId = ref(2000); 
                
                // 從 LocalStorage 載入 dayTwoOption，如果沒有則使用預設值 'A'
                const storedDayTwoOption = localStorage.getItem('dayTwoOption');
                const dayTwoOption = ref(storedDayTwoOption || 'A'); 

                const travelDates = ref(['12/17 (二)', '12/18 (三)', '12/19 (四)', '12/20 (五)', '12/21 (六)']);
                const currentDate = ref('12/17 (二)');
                
                const simulatedWeather = ref('11°C 晴'); 
                
                const collapsedFlights = reactive({ 1: false, 2: false });
                const noteVisibility = reactive({});

                // Modal 狀態 (行程 CRUD)
                const isModalOpen = ref(false);
                const editingItem = ref(null);
                const tempItem = reactive({
                    id: null,
                    date: currentDate.value,
                    time: '12:00',
                    location: '',
                    type: 'attraction',
                    note: '',
                    redNote: '',
                    option: null,
                });
                
                // Watcher 監聽 dayTwoOption 變動並儲存
                Vue.watch(dayTwoOption, (newValue) => {
                    localStorage.setItem('dayTwoOption', newValue);
                });

                // --- LocalStorage Keys ---
                const ITINERARY_STORAGE_KEY = 'tokyoItinerary_new'; // 更改 key 以載入新行程
                const EXPENSE_STORAGE_KEY = 'tokyoExpenses';
                const SHOPPING_STORAGE_KEY = 'tokyoShoppingList';

                // --- 輔助函式：根據類型取得圖標和顏色 ---
                const getIconAndColor = (type) => {
                    switch (type) {
                        case 'attraction':
                            return { iconClass: 'ph-map-pin', dotColor: 'bg-green-600' };
                        case 'restaurant':
                            return { iconClass: 'ph-fork-knife', dotColor: 'bg-red-500' };
                        case 'transport':
                            return { iconClass: 'ph-car', dotColor: 'bg-blue-500' };
                        default:
                            return { iconClass: 'ph-circle', dotColor: 'bg-violet-600' };
                    }
                };

                // --- 航班資訊 (無需持久化) ---
                const flights = ref([
                    { id: 1, type: '去程 (DEPARTURE)', date: '12/17 (二)', origin: 'TPE', originName: '桃園國際機場', destination: 'NRT', destinationName: '成田國際機場', depTime: '02:25', arrTime: '06:30', flightNum: 'MM620', airline: '樂桃 (Peach)', terminal: { dep: 'T1', arr: 'T1' } },
                    { id: 2, type: '回程 (RETURN)', date: '12/21 (六)', origin: 'NRT', originName: '成田國際機場', destination: 'TPE', destinationName: '桃園國際機場', depTime: '22:05', arrTime: '01:00 (+1)', flightNum: 'GK011', airline: '捷星 (Jetstar)', terminal: { dep: 'T3', arr: 'T1' } }
                ]);

                const currentFlights = computed(() => {
                    return flights.value.filter(flight => flight.date === currentDate.value);
                });

                const toggleCollapse = (flightId) => {
                    collapsedFlights[flightId] = !collapsedFlights[flightId];
                };


                // --- 1. 行程表狀態與邏輯 (更新行程內容並加入持久化) ---

                // 行程資料：載入或使用預設 (已替換為最新內容)
                const loadItinerary = () => {
                    const stored = localStorage.getItem(ITINERARY_STORAGE_KEY);
                    if (stored) {
                        return JSON.parse(stored);
                    }
                    // *** 使用提供的最新行程內容替換預設資料 ***
                    return [
                         // Day 1 — 12/17 | 河口湖
                         [span_0](start_span){ id: nextId.value++, date: '12/17 (二)', time: '08:00', location: '成田 → 新宿（成田特快）', type: 'transport', note: '可搭 08:12 或 08:49 班次[span_0](end_span)', redNote: null, showNote: false },
                         [span_1](start_span){ id: nextId.value++, date: '12/17 (二)', time: '10:30', location: '新宿 → 河口湖（富士回遊）', type: 'transport', note: '10:30 出發 → 12:23 抵達[span_1](end_span)', redNote: null, showNote: false },
                         [span_2](start_span){ id: nextId.value++, date: '12/17 (二)', time: '12:30', location: '前往飯店 MYSTAYS Check-in', type: 'attraction', note: '富士山展望溫泉飯店[span_2](end_span)', redNote: null, showNote: false },
                         [span_3](start_span)[span_4](start_span){ id: nextId.value++, date: '12/17 (二)', time: '14:00', location: '富士山遊船/河口湖遊覽船', type: 'attraction', note: '可順路安排[span_3](end_span)[span_4](end_span)', redNote: null, showNote: false },
                         [span_5](start_span){ id: nextId.value++, date: '12/17 (二)', time: '16:00', location: '富士山麵包/Plaza/餺飥烏龍麵', type: 'restaurant', note: 'Fujisan Shokupan (18:00 關) / Fujisan Plaza (18:00 關) / ほうとう不動 (19:00 關)[span_5](end_span)[span_6](start_span)', redNote: '風大偏冷，16:00後氣溫下降[span_6](end_span)', showNote: false },

                         // Day 2 — 12/18 | 山中湖 → 御殿場 → 箱根
                         [span_7](start_span){ id: nextId.value++, date: '12/18 (三)', time: '05:40', location: '産屋ヶ崎 (Ubuyagasaki) 觀賞日出', type: 'attraction', note: '氣溫非常低，建議穿羽絨＋手套[span_7](end_span)', redNote: null, showNote: false },
                         [span_8](start_span){ id: nextId.value++, date: '12/18 (三)', time: '07:00', location: '飯店早餐與退房', type: 'restaurant', note: '早餐 07:00 開始[span_8](end_span)', redNote: null, showNote: false },
                         
                         // 方案 A: 經過山中湖 (預設選中)
                         [span_9](start_span){ id: nextId.value++, date: '12/18 (三)', option: 'A', time: '07:30', location: '方案 A: 前往山中湖', type: 'transport', note: '07:00-07:38 或 07:30-08:30 → 富士急樂園[span_9](end_span)', redNote: null, showNote: false },
                         [span_10](start_span){ id: nextId.value++, date: '12/18 (三)', option: 'A', time: '09:48', location: '山中湖 → 御殿場 OUTLET', type: 'transport', note: '09:48–10:30[span_10](end_span)', redNote: null, showNote: false },
                         [span_11](start_span){ id: nextId.value++, date: '12/18 (三)', option: 'A', time: '10:30', location: '御殿場 OUTLET 購物 & 午餐', type: 'restaurant', note: '建議先逛北館再南館 (鞋 & 精品較多)[span_11](end_span)[span_12](start_span)', redNote: '風很強，建議戴圍巾[span_12](end_span)', showNote: false },
                         
                         // 方案 B: 直接前往 Outlet
                         [span_13](start_span){ id: nextId.value++, date: '12/18 (三)', option: 'B', time: '08:00', location: '方案 B: 富士急樂園 → 御殿場 OUTLET', type: 'transport', note: '直接前往 Outlet[span_13](end_span)', redNote: null, showNote: false },
                         [span_14](start_span){ id: nextId.value++, date: '12/18 (三)', option: 'B', time: '10:30', location: '御殿場 OUTLET 購物 & 午餐', type: 'restaurant', note: '建議先逛北館再南館 (鞋 & 精品較多)[span_14](end_span)[span_15](start_span)', redNote: '風很強，建議戴圍巾[span_15](end_span)', showNote: false },
                         
                         [span_16](start_span){ id: nextId.value++, date: '12/18 (三)', time: '15:00', location: 'OUTLET → 箱根飯店', type: 'transport', note: '巴士車程約 30 分鐘，15–30 分一班[span_16](end_span)', redNote: null, showNote: false },
                         [span_17](start_span){ id: nextId.value++, date: '12/18 (三)', time: '16:00', location: '箱根飯店 Check-in & 自由活動', type: 'attraction', note: '飯店：Blisstia 箱根仙石原[span_17](end_span)', redNote: null, showNote: false },
                         
                         // Day 3 — 12/19 | 箱根半日遊 → 東京淺草
                         [span_18](start_span){ id: nextId.value++, date: '12/19 (四)', time: '08:20', location: '大涌谷', type: 'attraction', note: '預計停留 1 小時[span_18](end_span)[span_19](start_span)', redNote: '若天氣不好，火山口煙霧會遮擋視線[span_19](end_span)', showNote: false },
                         [span_20](start_span){ id: nextId.value++, date: '12/19 (四)', time: '09:20', location: '移動至元箱根港 (纜車/巴士)', type: 'transport', note: '09:20–09:45[span_20](end_span)', redNote: null, showNote: false },
                         [span_21](start_span){ id: nextId.value++, date: '12/19 (四)', time: '09:45', location: '箱根神社／水上鳥居', type: 'attraction', note: '可能排隊 5–15 分鐘拍照[span_21](end_span)', redNote: null, showNote: false },
                         [span_22](start_span){ id: nextId.value++, date: '12/19 (四)', time: '10:20', location: '成川美術館', type: 'attraction', note: '觀景台能看到富士山（視天氣）[span_22](end_span)', redNote: null, showNote: false },
                         [span_23](start_span){ id: nextId.value++, date: '12/19 (四)', time: '11:20', location: '午餐 (Bakery & Table/田村銀杏/強羅咖啡)', type: 'restaurant', note: '從元箱根港出發[span_23](end_span)', redNote: null, showNote: false },
                         [span_24](start_span)[span_25](start_span){ id: nextId.value++, date: '12/19 (四)', time: '12:00', location: '海盜船：元箱根港 → 桃源台港', type: 'transport', note: '12:00 船班較容易客滿[span_24](end_span)[span_25](end_span)', redNote: null, showNote: false },
                         [span_26](start_span){ id: nextId.value++, date: '12/19 (四)', time: '12:30', location: '回飯店取行李', type: 'attraction', note: '桃源台港 → 飯店[span_26](end_span)', redNote: null, showNote: false },
                         [span_27](start_span){ id: nextId.value++, date: '12/19 (四)', time: '15:00', location: '箱根 → 東京淺草 (長途交通)', type: 'transport', note: '飯店→小田原(巴士)→東京(新幹線)→上野→淺草(APA Hotel 浅草雷門)[span_27](end_span)', redNote: null, showNote: false },
                         [span_28](start_span){ id: nextId.value++, date: '12/19 (四)', time: '17:00', location: '淺草自由行 (UNIQLO/仲見世通/晚餐)', type: 'attraction', note: '晚餐可考慮壽喜燒[span_28](end_span)', redNote: null, showNote: false },
                         
                         // Day 4 — 12/20 | 澀谷購物日 → 銀座晚餐
                         [span_29](start_span){ id: nextId.value++, date: '12/20 (五)', time: '10:00', location: '澀谷 All Day Shopping', type: 'attraction', note: '澀谷 PARCO, SHIBUYA109, Scramble Square[span_29](end_span)[span_30](start_span)', redNote: '澀谷容易迷路，可標記 Hachiko 做基準點[span_30](end_span)', showNote: false },
                         [span_31](start_span){ id: nextId.value++, date: '12/20 (五)', time: '19:00', location: '晚餐：肉屋の台所 Ginza Premium', type: 'restaurant', note: '營業至 23:00[span_31](end_span)[span_32](start_span)', redNote: '週五/週六建議提前預約[span_32](end_span)', showNote: false },

                         // Day 5 — 12/21 | 回程日
                         [span_33](start_span){ id: nextId.value++, date: '12/21 (六)', time: '11:00', location: '淺草自由活動/補買伴手禮', type: 'attraction', note: '可自由逛街[span_33](end_span)', redNote: null, showNote: false },
                         [span_34](start_span)[span_35](start_span){ id: nextId.value++, date: '12/21 (六)', time: '17:45', location: '前往成田機場', type: 'transport', note: '建議保留 3 小時以上到機場[span_34](end_span)[span_35](end_span)[span_36](start_span)', redNote: '成田第三航廈需步行 5–10 分鐘[span_36](end_span)', showNote: false },
                         [span_37](start_span){ id: nextId.value++, date: '12/21 (六)', time: '22:05', location: '登機並準備搭乘班機返台', type: 'transport', note: '飛機預計起飛時間[span_37](end_span)', redNote: null, showNote: false },
                    ];
                };
                
                const saveItinerary = (itemsArray) => {
                    localStorage.setItem(ITINERARY_STORAGE_KEY, JSON.stringify(itemsArray));
                };

                // 初始化時先載入 LocalStorage 中的行程
                const itineraryItems = ref(loadItinerary());


                const itineraryWithDuration = computed(() => {
                    const targetDate = currentDate.value;
                    let filtered = itineraryItems.value.filter(item => item.date === targetDate);

                    // 處理 Day 2 的方案選擇
                    if (targetDate === '12/18 (三)') {
                        filtered = filtered.filter(item => !item.option || item.option === dayTwoOption.value);
                    } else {
                        // 其他日子只顯示沒有 option 的項目
                        filtered = filtered.filter(item => !item.option);
                    }

                    const sortedItems = filtered.sort((a, b) => {
                        // 首先按時間排序
                        const timeComparison = a.time.localeCompare(b.time);
                        if (timeComparison !== 0) return timeComparison;
                        
                        // 時間相同時，確保 'A' 在 'B' 之前 (如果選項被加入)
                        if (a.date === '12/18 (三)') {
                            if (a.option === 'A' && b.option === 'B') return -1;
                            if (a.option === 'B' && b.option === 'A') return 1;
                        }
                        return 0;
                    });

                    return sortedItems.map((item, index) => {
                        const nextItem = sortedItems[index + 1];
                        let duration = nextItem ? calculateDuration(item.time, nextItem.time) : '結束';
                        
                        const { iconClass, dotColor } = getIconAndColor(item.type);
                        const isNoteVisible = noteVisibility[item.id] !== undefined ? noteVisibility[item.id] : false;
                        
                        return { ...item, duration, iconClass, dotColor, showNote: isNoteVisible };
                    });
                });

                const toggleNote = (itemId) => {
                    if (noteVisibility[itemId] === undefined) {
                        noteVisibility[itemId] = true;
                    } else {
                        noteVisibility[itemId] = !noteVisibility[itemId];
                    }
                };

                const saveItineraryLocally = () => {
                      saveItinerary(itineraryItems.value);
                };

                // 行程 CRUD
                const resetTempItem = () => {
                      Object.assign(tempItem, { id: null, date: currentDate.value, time: '12:00', location: '', type: 'attraction', note: '', redNote: null, option: null });
                };
                
                const closeModal = () => {
                    isModalOpen.value = false;
                    editingItem.value = null;
                    resetTempItem();
                };

                const openAddItemModal = () => {
                    resetTempItem();
                    tempItem.date = currentDate.value;
                    isModalOpen.value = true;
                };

                const editItem = (item) => {
                    Object.assign(tempItem, {
                        id: item.id, date: item.date, time: item.time, location: item.location, type: item.type,
                        note: item.note || '', redNote: item.redNote || null, option: item.option || null,
                    });
                    editingItem.value = item;
                    isModalOpen.value = true;
                };

                const saveItem = () => {
                    if (!tempItem.location || !tempItem.time) return;

                    if (editingItem.value) {
                        const index = itineraryItems.value.findIndex(item => item.id === tempItem.id);
                        if (index !== -1) {
                            Object.assign(itineraryItems.value[index], {
                                date: tempItem.date, time: tempItem.time, location: tempItem.location,
                                type: tempItem.type, note: tempItem.note, redNote: tempItem.redNote || null,
                                option: tempItem.option,
                            });
                        }
                    } else {
                        const newItem = {
                            ...tempItem,
                            id: Date.now(),
                            option: (tempItem.date === '12/18 (三)') ? dayTwoOption.value : null 
                        };
                        itineraryItems.value.push(newItem);
                    }
                    saveItinerary(itineraryItems.value); // 儲存變更
                    closeModal();
                };

                const deleteItem = (itemId) => {
                    const confirmDelete = window.confirm("確定要刪除此行程嗎？");
                    if (confirmDelete) {
                        itineraryItems.value = itineraryItems.value.filter(item => item.id !== itemId);
                        saveItinerary(itineraryItems.value); // 儲存變更
                        closeModal();
                    }
                };


                // --- 2. 記帳系統狀態與邏輯 ---
                const jpyToTwdRate = 0.201; 
                const expenseCategories = ref(['餐飲', '交通', '住宿', '購物', '門票', '其他']);

                const loadExpenses = () => {
                    const stored = localStorage.getItem(EXPENSE_STORAGE_KEY);
                    if (stored) return JSON.parse(stored);
                    
                    return [
                        { id: expenseNextId.value++, date: '12/17 (二)', description: '機票 (TWD)', amount: 16080, amountJpy: 0, category: '交通' }, 
                        { id: expenseNextId.value++, date: '12/17 (二)', description: '富士回遊車票', amount: 2010, amountJpy: 10000, category: '交通' },
                        { id: expenseNextId.value++, date: '12/18 (三)', description: '御殿場午餐', amount: 1206, amountJpy: 6000, category: '餐飲' },
                        { id: expenseNextId.value++, date: '12/18 (三)', description: '箱根住宿', amount: 3618, amountJpy: 18000, category: '住宿' },
                    ];
                };

                const saveExpenses = (expensesArray) => {
                    localStorage.setItem(EXPENSE_STORAGE_KEY, JSON.stringify(expensesArray));
                };

                const expenses = ref(loadExpenses());

                const newExpense = reactive({
                    description: '',
                    amountJpy: null, 
                    amountTwd: null, 
                    category: '',
                    date: currentDate.value,
                });
                
                const updateAmount = (source, value) => {
                    const numericValue = parseFloat(value);
                    if (isNaN(numericValue) || numericValue < 0) {
                        newExpense.amountJpy = null;
                        newExpense.amountTwd = null;
                        return;
                    }
                    
                    if (source === 'jpy') {
                        newExpense.amountJpy = numericValue;
                        newExpense.amountTwd = numericValue * jpyToTwdRate;
                    } else if (source === 'twd') {
                        newExpense.amountTwd = numericValue;
                        newExpense.amountJpy = numericValue / jpyToTwdRate;
                    }
                };
                
                const calculatedTwdAmount = computed(() => {
                    return newExpense.amountTwd !== null ? newExpense.amountTwd.toFixed(0) : '';
                });

                const calculatedJpyAmount = computed(() => {
                    return newExpense.amountJpy !== null ? newExpense.amountJpy.toFixed(0) : 0;
                });

                const canAddExpense = computed(() => {
                    return newExpense.description && newExpense.amountTwd > 0 && newExpense.category;
                });

                const addExpense = () => {
                    if (canAddExpense.value) {
                        expenses.value.push({
                            id: Date.now(), 
                            date: currentDate.value,
                            description: newExpense.description,
                            amountJpy: newExpense.amountJpy !== null ? parseFloat(newExpense.amountJpy.toFixed(0)) : 0,
                            amount: newExpense.amountTwd,
                            category: newExpense.category,
                        });
                        saveExpenses(expenses.value);

                        newExpense.description = '';
                        newExpense.amountJpy = null;
                        newExpense.amountTwd = null;
                        newExpense.category = '';
                    }
                };
                
                const deleteExpense = (expenseId) => {
                    const confirmDelete = window.confirm("確定要刪除此筆支出紀錄嗎？");
                    if (confirmDelete) {
                        expenses.value = expenses.value.filter(exp => exp.id !== expenseId);
                        saveExpenses(expenses.value);
                    }
                };
                
                const totalTwdSpent = computed(() => {
                    return expenses.value.reduce((sum, exp) => sum + exp.amount, 0);
                });
                
                const sortedExpenses = computed(() => {
                    return [...expenses.value].sort((a, b) => b.id - a.id);
                });

                const getCategoryColor = (category) => {
                    switch (category) {
                        case '餐飲': return 'bg-orange-100 text-orange-800';
                        case '交通': return 'bg-blue-100 text-blue-800';
                        case '住宿': return 'bg-purple-100 text-purple-800';
                        case '購物': return 'bg-pink-100 text-pink-800';
                        case '門票': return 'bg-green-100 text-green-800';
                        default: return 'bg-neutral-200 text-neutral-800';
                    }
                };


                // --- 3. 地圖狀態與邏輯 ---
                const filteredItinerary = computed(() => itineraryWithDuration.value.filter(item => !item.option)); 

                const mapRouteQuery = computed(() => {
                    const items = filteredItinerary.value;
                    if (items.length === 0) return '';
                    const meaningfulLocations = items
                        .filter(item => item.type !== 'transport') 
                        .map(item => item.location + ', Japan');

                    if (meaningfulLocations.length === 0) return '';

                    const origin = encodeURIComponent(meaningfulLocations[0]);
                    const destination = encodeURIComponent(meaningfulLocations[meaningfulLocations.length - 1]);
                    
                    let waypoints = '';
                    if (meaningfulLocations.length > 2) {
                        const middleStops = meaningfulLocations.slice(1, meaningfulLocations.length - 1);
                        waypoints = middleStops.map(item => encodeURIComponent(item)).join('|');
                        waypoints = `&waypoints=${waypoints}`;
                    }
                    
                    if (meaningfulLocations.length === 1) {
                         const searchUrl = `https://www.google.com/maps/search/?api=1&query=${origin}`;
                         return searchUrl;
                    }

                    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=driving`;
                    return url;
                });

                const openItineraryRoute = () => {
                    const url = mapRouteQuery.value;
                    if (url) {
                        window.open(url, '_blank');
                    }
                };

                // --- 4. 購物清單狀態與邏輯 ---
                const loadShoppingList = () => {
                    const stored = localStorage.getItem(SHOPPING_STORAGE_KEY);
                    if (stored) return JSON.parse(stored);
                    
                    return [
                        { id: shoppingNextId.value++, name: 'Uniqlo 發熱衣 (M)', quantity: 2, done: false, image: null },
                        { id: shoppingNextId.value++, name: '薯條三兄弟', quantity: 5, done: false, image: null },
                        { id: shoppingNextId.value++, name: '東京巴奈奈', quantity: 1, done: true, image: null },
                    ];
                };

                const saveShoppingList = (listArray) => {
                    localStorage.setItem(SHOPPING_STORAGE_KEY, JSON.stringify(listArray));
                };

                const shoppingList = ref(loadShoppingList());

                const newShoppingItem = reactive({
                    name: '',
                    quantity: 1,
                    image: null, 
                    imagePreview: null, 
                });

                const imageInput = ref(null); 

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            newShoppingItem.image = e.target.result; 
                            newShoppingItem.imagePreview = file.name;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        newShoppingItem.image = null;
                        newShoppingItem.imagePreview = null;
                    }
                };

                const canAddShoppingItem = computed(() => {
                    return newShoppingItem.name.trim() !== '' && newShoppingItem.quantity > 0;
                });

                const addShoppingItem = () => {
                    if (canAddShoppingItem.value) {
                        shoppingList.value.push({
                            id: Date.now(),
                            name: newShoppingItem.name,
                            quantity: newShoppingItem.quantity,
                            done: false,
                            image: newShoppingItem.image, 
                        });
                        saveShoppingList(shoppingList.value);
                        
                        newShoppingItem.name = '';
                        newShoppingItem.quantity = 1;
                        newShoppingItem.image = null;
                        newShoppingItem.imagePreview = null;
                        if (imageInput.value) imageInput.value.value = ''; 
                    }
                };

                const deleteShoppingItem = (itemId) => {
                    const confirmDelete = window.confirm("確定要刪除此購物項目嗎？");
                    if (confirmDelete) {
                        shoppingList.value = shoppingList.value.filter(item => item.id !== itemId);
                        saveShoppingList(shoppingList.value);
                    }
                };

                const toggleShoppingDone = (itemId) => {
                    const item = shoppingList.value.find(item => item.id === itemId);
                    if (item) {
                        item.done = !item.done;
                        saveShoppingList(shoppingList.value);
                    }
                };

                const sortedShoppingList = computed(() => {
                    return [...shoppingList.value].sort((a, b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);
                });

                const pendingShoppingItems = computed(() => {
                    return shoppingList.value.filter(item => !item.done);
                });


                return {
                    activeTab,
                    travelDates,
                    currentDate,
                    simulatedWeather,
                    dayTwoOption,
                    // Flights
                    currentFlights,
                    collapsedFlights,
                    toggleCollapse,
                    // Itinerary CRUD & Display
                    itineraryWithDuration,
                    getIconAndColor,
                    toggleNote,
                    saveItineraryLocally, 
                    // Modal Logic
                    isModalOpen,
                    editingItem,
                    tempItem,
                    openAddItemModal,
                    editItem,
                    saveItem,
                    deleteItem,
                    closeModal,
                    // Ledger
                    expenses,
                    expenseCategories,
                    newExpense,
                    canAddExpense,
                    addExpense,
                    deleteExpense,
                    updateAmount, 
                    calculatedTwdAmount,
                    calculatedJpyAmount,
                    totalTwdSpent,
                    sortedExpenses,
                    getCategoryColor,
                    jpyToTwdRate,
                    // Map
                    filteredItinerary,
                    openItineraryRoute,
                    // Shopping List
                    shoppingList,
                    newShoppingItem,
                    handleImageUpload,
                    canAddShoppingItem,
                    addShoppingItem,
                    deleteShoppingItem,
                    toggleShoppingDone,
                    sortedShoppingList,
                    pendingShoppingItems,
                    imageInput, 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

